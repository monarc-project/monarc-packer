#cloud-config

autoinstall:
  version: 1
  locale: en_US.UTF-8
  keyboard:
    layout: us
    variant: ""
    toggle: ""
    network:
      network:
        version: 2
        ethernets:
          ens192:
            dhcp4: true
  #manage_etc_hosts: false
  #write_files:
  #  - encoding: b64
  #    content: W01hdGNoXQpOYW1lPWV0aDAKCltOZXR3b3JrXQpESENQPWlwdjQK
  #    owner: root:root
  #    path: /etc/systemd/network/eth0.network
  #    permissions: '0644'
  storage:
    layout:
      name: lvm
  apt:
    geoip: true
    preserve_sources_list: false
    disable_components: []
    primary:
      - arches: [amd64, i386]
        uri: http://us.archive.ubuntu.com/ubuntu
      - arches: [default]
        uri: http://ports.ubuntu.com/ubuntu-ports
  #identity:
  #  hostname: ubuntu-server
  #  username: monarc
  #  password: $6$VuqVY2Sp3qcI96WA$4Oh.azByigZQAWVvOMWSupsCNPpWjPMAn9n5ETy8barjNdg7ndUStKSVYWMaqkt5p6VEOKkoG5NrEioPWxBbP.
  ssh:
    install-server: yes
    allow-pw: yes
    disable_root: false
  user-data:
    disable_root: false
    timezone: UTC
    users:
    - default
    - name: monarc
      passwd: '$6$VuqVY2Sp3qcI96WA$4Oh.azByigZQAWVvOMWSupsCNPpWjPMAn9n5ETy8barjNdg7ndUStKSVYWMaqkt5p6VEOKkoG5NrEioPWxBbP.'
      shell: /bin/bash
      lock-passwd: false
      ssh_pwauth: True
      chpasswd: { expire: False }
      sudo: ALL=(ALL) NOPASSWD:ALL
      groups: users, admin
      locale: en_US
      keyboard:
        layout: en
        variant: us
    chpasswd:
      expire: false
      list:
        - ubuntu:$6$VuqVY2Sp3qcI96WA$4Oh.azByigZQAWVvOMWSupsCNPpWjPMAn9n5ETy8barjNdg7ndUStKSVYWMaqkt5p6VEOKkoG5NrEioPWxBbP.
  packages:
    - openssh-server
    - open-vm-tools
    - cloud-init
    - whois
    - zsh
    - wget
    - sed
    - curl
    - git
    - sudo
    - software-properties-common
    - sshpass
    - dialog
    - apt-utils
  #package_update: true
  #package_upgrade: true
  #package_reboot_if_required: true
  final_message: "System installation complete."
  early-commands:
    - sudo ufw disable
    - sudo systemctl stop ssh
    - sudo touch /etc/cloud/cloud-init.disabled
    - sed -i "s/#Cache=.*/Cache=yes/g" /etc/systemd/resolved.conf
    - sed -i "s/#DNS=.*/DNS=4.2.2.1 4.2.2.2 208.67.220.220/g" /etc/systemd/resolved.conf
    - sed -i "s/#FallbackDNS=.*/FallbackDNS=4.2.2.1 4.2.2.2 208.67.220.220/g" /etc/systemd/resolved.conf
    - sudo systemctl restart systemd-resolved
  late-commands:
    - sed -i -e 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/g' /target/etc/ssh/sshd_config
    - echo 'monarc ALL=(ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/monarc
    - curtin in-target --target=/target -- chmod 440 /etc/sudoers.d/monarc
    - sed -i 's/^GRUB_CMDLINE_LINUX_DEFAULT="\(.*\)"$/GRUB_CMDLINE_LINUX_DEFAULT=="\1 net.ifnames=0 biosdevname=0"/g' /target/etc/default/grub
    - sed -i 's/^GRUB_CMDLINE_LINUX_DEFAULT=" net.ifnames/GRUB_CMDLINE_LINUX_DEFAULT="net.ifnames/g' /target/etc/default/grub
    - echo "PermitRootLogin yes" >> /target/etc/ssh/sshd_config
    - sudo chroot /target /bin/bash -c '/usr/sbin/useradd --create-home --shell /bin/bash --password monarc monarc'
    - sudo chroot /target /bin/bash -c 'printf "monarc\nmonarc\n" | passwd root'
    - sudo systemctl start ssh
